# Minimal Conditional DDPM (MNIST) - PyTorch Implementation

[English](README.md) | ä¸­æ–‡

è¿™æ˜¯ä¸€ä¸ªåŸºäº PyTorch å®ç°çš„æ¡ä»¶ç”Ÿæˆæ‰©æ•£æ¨¡å‹ (Conditional DDPM)ï¼Œç”¨äºç”Ÿæˆ MNIST æ‰‹å†™æ•°å­—ã€‚

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªè½»é‡çº§çš„ Context U-Netï¼Œç»“åˆäº† Classifier-Free Guidance (CFG) æŠ€æœ¯ï¼Œä¸ä»…å¯ä»¥æŒ‡å®šç”Ÿæˆç‰¹å®šçš„æ•°å­—ï¼ˆ0-9ï¼‰ï¼Œè¿˜å¯ä»¥å¯è§†åŒ–æ‰©æ•£æ¨¡å‹çš„å»å™ªè¿‡ç¨‹ã€‚

## âœ¨ é¡¹ç›®ç‰¹ç‚¹

* æç®€ä»£ç ï¼šæ ¸å¿ƒé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£æ‰©æ•£æ¨¡å‹ï¼ˆDDPMï¼‰åŸç†ã€‚
* æ¡ä»¶ç”Ÿæˆï¼šæ”¯æŒæŒ‡å®šæ•°å­—ç”Ÿæˆï¼ˆä¾‹å¦‚ï¼šâ€œç»™æˆ‘ç”Ÿæˆä¸€ä¸ªæ•°å­— 5â€ï¼‰ã€‚
* å»å™ªå¯è§†åŒ–ï¼šæ”¯æŒç”Ÿæˆä»çº¯å™ªå£°åˆ°æ¸…æ™°æ•°å­—çš„è§†é¢‘æ¼”ç¤ºã€‚
* æ— åˆ†ç±»å™¨å¼•å¯¼ (CFG)ï¼šè®­ç»ƒä¸­å¼•å…¥äº† Context Maskï¼Œå¢å¼ºäº†ç”Ÿæˆçš„æ§åˆ¶åŠ›ã€‚

## ğŸ“¦ ç¯å¢ƒä¾èµ–

è¯·ç¡®ä¿å®‰è£…äº†ä»¥ä¸‹ Python åº“ï¼š

```bash
pip install torch torchvision numpy opencv-python pillow
```

(æ³¨ï¼šopencv-python ç”¨äºç”Ÿæˆè§†é¢‘ï¼Œpillow ç”¨äºæ‹¼æ¥å›¾ç‰‡)

## ğŸ“‚ æ–‡ä»¶ç»“æ„è¯´æ˜

æœ¬é¡¹ç›®åŒ…å« 4 ä¸ªæ ¸å¿ƒ Python æ–‡ä»¶ï¼Œå„å¸å…¶èŒï¼š

### 1. ddpm_model.py (æ ¸å¿ƒæ¨¡å‹)

è¿™æ˜¯é¡¹ç›®çš„â€œå¤§è„‘â€ã€‚

* ContextUnet: å®šä¹‰äº†ä¸€ä¸ªå¸¦æœ‰æ—¶åºåµŒå…¥ï¼ˆTime Embeddingï¼‰å’Œä¸Šä¸‹æ–‡åµŒå…¥ï¼ˆContext Embeddingï¼‰çš„ U-Net ç½‘ç»œã€‚
* DDPM: å®šä¹‰äº†æ‰©æ•£è¿‡ç¨‹çš„å‰å‘åŠ å™ªå’Œåå‘å»å™ªé€»è¾‘ã€‚åŒ…å«äº† sample å‡½æ•°ï¼Œå®ç°äº†åŸºäº Classifier-Free Guidance çš„é‡‡æ ·ç®—æ³•ã€‚

### 2. train_ddpm.py (è®­ç»ƒè„šæœ¬)

è¿™æ˜¯æ¨¡å‹çš„â€œå¥èº«æˆ¿â€ã€‚

* è´Ÿè´£ä¸‹è½½ MNIST æ•°æ®é›†ã€‚
* åˆå§‹åŒ–æ¨¡å‹å¹¶å°†å…¶ç§»åŠ¨åˆ° GPUï¼ˆå¦‚æœå¯ç”¨ï¼‰ã€‚
* æ‰§è¡Œ 30 ä¸ª Epoch çš„è®­ç»ƒå¾ªç¯ï¼Œå¹¶å®šæœŸä¿å­˜æ¨¡å‹æƒé‡åˆ° ./weights/ddpm_mnist.pthã€‚
* è®­ç»ƒæ—¶é‡‡ç”¨äº† drop_prob=0.1 æ¥éšæœºä¸¢å¼ƒæ¡ä»¶ï¼Œä»¥æ”¯æŒ CFG æ¨ç†ã€‚

### 3. inference_ddpm.py (æ¨ç†ä¸ç”Ÿæˆ)

è¿™æ˜¯æ¨¡å‹çš„â€œç”»ç¬”â€ã€‚æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

* å›¾ç‰‡æ¨¡å¼ (é»˜è®¤)ï¼šåŠ è½½è®­ç»ƒå¥½çš„æƒé‡ï¼Œç”ŸæˆæŒ‡å®šæ•°å­—çš„ç½‘æ ¼å›¾ã€‚
* è§†é¢‘æ¨¡å¼ (--video)ï¼šç”Ÿæˆæ•°å­— 0-9 ä»å®Œå…¨å™ªå£°é€æ¸å˜æ¸…æ™°çš„ MP4 è§†é¢‘ï¼Œç›´è§‚å±•ç¤ºæ‰©æ•£è¿‡ç¨‹ã€‚

### 4. stitch_images.py (å·¥å…·è„šæœ¬)

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è¾…åŠ©å·¥å…·ã€‚

* å®ƒä¼šè¯»å– generated_outputs æ–‡ä»¶å¤¹ä¸‹çš„ digit_0_grid.png åˆ° digit_9_grid.pngã€‚
* å°†è¿™ 10 å¼ å›¾ç‰‡æ‹¼æˆä¸€ä¸ª 2è¡Œ x 5åˆ— çš„å¤§å›¾ (combined_2x5_grid.png)ï¼Œæ–¹ä¾¿ç»Ÿä¸€å±•ç¤ºç»“æœã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

> **ğŸ“Œ æ³¨æ„ï¼š** æœ¬é¡¹ç›®å·²ç»åŒ…å«äº†ä¸€ä¸ªé¢„è®­ç»ƒå®Œæˆçš„æ¨¡å‹æ–‡ä»¶ï¼Œä¿å­˜åœ¨ `./weights/ddpm_mnist.pth` ä¸­ã€‚æ‚¨å¯ä»¥è·³è¿‡è®­ç»ƒæ­¥éª¤ï¼Œç›´æ¥ä½¿ç”¨è¯¥æ¨¡å‹è¿›è¡Œæ¨ç†æŸ¥çœ‹æ•ˆæœã€‚

### ç¬¬ä¸€æ­¥ï¼šè®­ç»ƒæ¨¡å‹ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æƒ³è‡ªå·±è®­ç»ƒæ¨¡å‹ï¼Œå¯ä»¥è¿è¡Œè®­ç»ƒè„šæœ¬ï¼Œè®­ç»ƒè¿‡ç¨‹åœ¨ GTX 1060 æˆ– Colab T4 ä¸Šé€šå¸¸åªéœ€å‡ åˆ†é’Ÿã€‚

```bash
python train_ddpm.py
```

è®­ç»ƒå®Œæˆåï¼Œæƒé‡æ–‡ä»¶å°†ä¿å­˜åœ¨ weights/ddpm_mnist.pth ã€‚

### ç¬¬äºŒæ­¥ï¼šç”Ÿæˆå›¾åƒ

ç”Ÿæˆå•ä¸ªæ•°å­—ï¼ˆä¾‹å¦‚æ•°å­— 5ï¼‰ï¼š

```bash
python inference_ddpm.py --digit 5 --count 9
```

* --digit: æƒ³è¦ç”Ÿæˆçš„æ•°å­— (0-9)ã€‚
* --count: ç”Ÿæˆçš„æ•°é‡ï¼ˆå»ºè®®å¹³æ–¹æ•°ï¼Œå¦‚ 9, 16, 25ï¼‰ã€‚
* ç»“æœä¿å­˜åœ¨ generated_outputs/digit_5_grid.png ã€‚

ç”Ÿæˆå»å™ªè¿‡ç¨‹è§†é¢‘ï¼š

```bash
python inference_ddpm.py --video
```

* ç»“æœä¿å­˜åœ¨ generated_outputs/denoising_process_0to9.mp4ã€‚

### ç¬¬ä¸‰æ­¥ï¼šæ‹¼æ¥æ‰€æœ‰æ•°å­— (å¯é€‰)

å¦‚æœä½ æƒ³ç”Ÿæˆä¸€å¼ åŒ…å« 0-9 æ‰€æœ‰æ•°å­—çš„æ±‡æ€»å›¾ï¼š

1. å…ˆç”Ÿæˆæ‰€æœ‰æ•°å­—çš„å›¾ç‰‡ï¼ˆå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ Shell è„šæœ¬æˆ–æ‰‹åŠ¨è¿è¡Œï¼‰ï¼š

   Windows PowerShell

   ```powershell
   0..9 | ForEach-Object { python inference_ddpm.py --digit $_ --count 9 }
   ```

   Linux / Mac

   ```bash
   for i in {0..9}; do python inference_ddpm.py --digit $i --count 9; done
   ```
2. è¿è¡Œæ‹¼æ¥è„šæœ¬ï¼š

   ```
   python stitch_images.py
   ```
3. æŸ¥çœ‹ç”Ÿæˆçš„ combined_2x5_grid.pngã€‚

## ğŸ“Š ç»“æœé¢„è§ˆ

![1766044209241](image/README/1766044209241.png)

## ğŸ“ å¼•ç”¨ä¸å‚è€ƒ

* [Denoising Diffusion Probabilistic Models (Ho et al., 2020)](https://arxiv.org/abs/2006.11239)
